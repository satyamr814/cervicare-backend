<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cervical Health Risk Assessment Chatbot</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }

    body {
      background: #f7fbff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(6, 147, 140, 0.1);
      width: 100%;
      max-width: 800px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(6, 147, 140, 0.1);
    }

    .header {
      background: linear-gradient(135deg, #06938c 0%, #04706a 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(6, 147, 140, 0.2);
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
      font-weight: 700;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
      font-weight: 400;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #fdfdfd;
      scroll-behavior: smooth;
    }

    .message {
      margin-bottom: 15px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .bot-message {
      display: flex;
      align-items: flex-start;
    }

    .bot-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #06938c 0%, #04706a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      margin-right: 10px;
      flex-shrink: 0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .bot-text {
      background: white;
      padding: 12px 16px;
      border-radius: 18px;
      border-top-left-radius: 4px;
      /* Distinctive bot shape */
      max-width: 75%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      line-height: 1.6;
      border: 1px solid #eef2f6;
      color: #333;
    }

    .user-message {
      display: flex;
      justify-content: flex-end;
      align-items: flex-start;
    }

    .user-text {
      background: linear-gradient(135deg, #06938c 0%, #04706a 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 18px;
      border-top-right-radius: 4px;
      /* Distinctive user shape */
      max-width: 75%;
      box-shadow: 0 4px 10px rgba(6, 147, 140, 0.2);
    }

    .result-box {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 15px;
      border: 1px solid #eef2f6;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .risk-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
      margin: 10px 0;
    }

    .risk-low {
      background: #10b981;
      color: white;
    }

    .risk-medium {
      background: #f59e0b;
      color: white;
    }

    .risk-high {
      background: #ef4444;
      color: white;
    }

    .probability-gauge {
      width: 100%;
      height: 30px;
      background: #e5e7eb;
      border-radius: 15px;
      overflow: hidden;
      margin: 15px 0;
      position: relative;
    }

    .probability-fill {
      height: 100%;
      transition: width 0.5s ease;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
    }

    .question-area {
      padding: 20px;
      background: white;
      border-top: 1px solid #eef2f6;
    }

    .options-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .option-btn {
      padding: 10px 20px;
      border: 1px solid #06938c;
      background: white;
      color: #06938c;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .option-btn:hover {
      background: linear-gradient(135deg, #06938c 0%, #04706a 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(6, 147, 140, 0.3);
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .number-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #eef2f6;
      border-radius: 25px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s;
      font-family: inherit;
    }

    .number-input:focus {
      border-color: #06938c;
    }

    .submit-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #06938c 0%, #04706a 100%);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(6, 147, 140, 0.3);
    }

    .submit-btn:active {
      transform: scale(0.95);
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(6, 147, 140, 0.2);
      border-radius: 50%;
      border-top-color: #06938c;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .explain-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background: #64748b;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.3s;
    }

    .explain-btn:hover {
      background: #475569;
    }

    .progress-indicator {
      text-align: center;
      color: #94a3b8;
      font-size: 12px;
      margin-top: 10px;
      font-weight: 500;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üè• Cervical Health Risk Assessment</h1>
      <p>Answer a few questions to assess your risk level</p>
    </div>

    <div class="chat-container" id="conversation"></div>

    <div class="question-area" id="question-area"></div>
  </div>

  <script>
    const state = {
      Age: null,
      Num_of_sexual_partners: null,
      First_sex_age: null,
      Num_of_pregnancies: null,
      Smokes_years: 0,
      Hormonal_contraceptives: 'No',
      Hormonal_contraceptives_years: 0,
      STDs_HIV: 'No',
      Pain_during_intercourse: 'No',
      Vaginal_discharge_type: 'None',
      Vaginal_discharge_color: 'normal',
      Vaginal_bleeding_timing: 'None'
    };

    const conversation = document.getElementById('conversation');
    const qArea = document.getElementById('question-area');

    function bot(msg, isResult = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot-message';

      const avatar = document.createElement('div');
      avatar.className = 'bot-avatar';
      avatar.textContent = 'ü§ñ';

      const text = document.createElement('div');
      text.className = 'bot-text';
      text.innerHTML = msg;

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(text);
      conversation.appendChild(messageDiv);

      if (isResult) {
        const resultBox = document.createElement('div');
        resultBox.className = 'result-box';
        resultBox.innerHTML = msg;
        text.innerHTML = '';
        text.appendChild(resultBox);
      }

      conversation.scrollTop = conversation.scrollHeight;
    }

    function user(msg) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message user-message';

      const text = document.createElement('div');
      text.className = 'user-text';
      text.textContent = msg;

      messageDiv.appendChild(text);
      conversation.appendChild(messageDiv);
      conversation.scrollTop = conversation.scrollHeight;
    }

    const steps = [
      { key: 'Age', text: 'What is your age?', type: 'number' },
      { key: 'Num_of_sexual_partners', text: 'How many sexual partners have you had?', type: 'number' },
      { key: 'First_sex_age', text: 'At what age did you first have sexual intercourse?', type: 'number' },
      { key: 'Num_of_pregnancies', text: 'How many pregnancies have you had?', type: 'number' },
      { key: 'Smokes_years', text: 'How many years have you been smoking? (Enter 0 if you don\'t smoke)', type: 'number' },
      { key: 'Hormonal_contraceptives', text: 'Are you currently using hormonal contraceptives?', type: 'options', options: ['Yes', 'No'] },
      { key: 'Hormonal_contraceptives_years', text: 'If yes, for how many years? (Enter 0 if not applicable)', type: 'number', conditional: 'Hormonal_contraceptives', conditionalValue: 'Yes' },
      { key: 'STDs_HIV', text: 'What is your HIV status?', type: 'options', options: ['No', 'Yes'] },
      { key: 'Pain_during_intercourse', text: 'Do you experience pain during intercourse?', type: 'options', options: ['Yes', 'No'] },
      { key: 'Vaginal_discharge_type', text: 'What type of vaginal discharge do you experience?', type: 'options', options: ['None', 'watery', 'thick', 'bloody'] },
      { key: 'Vaginal_discharge_color', text: 'What color is your vaginal discharge?', type: 'options', options: ['normal', 'pink', 'pale', 'bloody'] },
      { key: 'Vaginal_bleeding_timing', text: 'When do you experience abnormal vaginal bleeding?', type: 'options', options: ['None', 'Between periods', 'After sex', 'After menopause'] },
    ];

    let stepIndex = 0;
    let currentInput = null;

    function askNext() {
      if (stepIndex >= steps.length) {
        bot("Thanks for your answers! Analyzing your risk...");
        qArea.innerHTML = '<div class="loading"></div>';
        sendToBackend();
        return;
      }

      const s = steps[stepIndex];

      // Skip conditional questions if condition not met
      if (s.conditional && state[s.conditional] !== s.conditionalValue) {
        stepIndex++;
        askNext();
        return;
      }

      qArea.innerHTML = '';

      // Create question container
      const questionContainer = document.createElement('div');
      questionContainer.style.marginBottom = '15px';

      // Add question text
      const questionText = document.createElement('div');
      questionText.className = 'bot-text';
      questionText.textContent = s.text;
      questionText.style.marginBottom = '15px';
      questionContainer.appendChild(questionText);

      // Add progress indicator
      const progressDiv = document.createElement('div');
      progressDiv.className = 'progress-indicator';
      progressDiv.textContent = `Question ${stepIndex + 1} of ${steps.length}`;
      questionContainer.appendChild(progressDiv);

      // Add bot message with question
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot-message';
      const avatar = document.createElement('div');
      avatar.className = 'bot-avatar';
      avatar.textContent = 'ü§ñ';
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(questionContainer);
      conversation.appendChild(messageDiv);

      if (s.type === 'options') {
        // Options directly in question area, right below question
        const div = document.createElement('div');
        div.className = 'options-container';
        div.style.marginTop = '10px';
        s.options.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'option-btn';
          btn.textContent = opt;
          btn.onclick = () => {
            user(opt);
            state[s.key] = opt;
            stepIndex++;
            askNext();
          };
          div.appendChild(btn);
        });
        qArea.appendChild(div);
      } else if (s.type === 'number') {
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';
        inputGroup.style.marginTop = '10px';

        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'number-input';
        input.placeholder = 'Enter a number';
        input.id = 'num_input';
        currentInput = input;

        const btn = document.createElement('button');
        btn.className = 'submit-btn';
        btn.textContent = 'Next';
        btn.onclick = () => handleNumberInput(s, input);

        // Enter key support
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            handleNumberInput(s, input);
          }
        });

        inputGroup.appendChild(input);
        inputGroup.appendChild(btn);
        qArea.appendChild(inputGroup);

        // Auto-focus input
        setTimeout(() => input.focus(), 100);
      }

      conversation.scrollTop = conversation.scrollHeight;
    }

    function handleNumberInput(step, input) {
      const v = input.value;
      const numValue = Number(v || 0);
      user(v || '0');
      state[step.key] = numValue;
      stepIndex++;
      askNext();
    }

    async function sendToBackend() {
      try {
        const payload = {
          Age: state.Age,
          Num_of_sexual_partners: state.Num_of_sexual_partners,
          First_sex_age: state.First_sex_age,
          Num_of_pregnancies: state.Num_of_pregnancies,
          Smokes_years: state.Smokes_years,
          Hormonal_contraceptives: state.Hormonal_contraceptives,
          Hormonal_contraceptives_years: state.Hormonal_contraceptives_years,
          STDs_HIV: state.STDs_HIV,
          Pain_during_intercourse: state.Pain_during_intercourse,
          Vaginal_discharge_type: state.Vaginal_discharge_type,
          Vaginal_discharge_color: state.Vaginal_discharge_color,
          Vaginal_bleeding_timing: state.Vaginal_bleeding_timing
        };

        const resp = await fetch('/predict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await resp.json();
        qArea.innerHTML = '';

        if (resp.ok) {
          const riskClass = `risk-${data.risk_bucket.toLowerCase()}`;
          const probPercent = data.probability_percent || (data.probability * 100).toFixed(1);

          // Construct the custom plan URL
          const planUrl = `http://localhost:3000/protection.html?risk=${probPercent}&age=${state.Age || 0}&smoke=${state.Smokes_years || 0}&partners=${state.Num_of_sexual_partners || 0}&contra=${state.Hormonal_contraceptives || 'No'}`;

          const resultHTML = `
            <div style="text-align: center;">
              <h3 style="margin-bottom: 15px;">Risk Assessment Result</h3>
              <div class="risk-badge ${riskClass}" style="background: ${data.risk_color || '#6b7280'};">
                ${data.risk_bucket} Risk
              </div>
              <div style="margin: 20px 0;">
                <div style="font-size: 36px; font-weight: bold; color: ${data.risk_color || '#6b7280'};">
                  ${probPercent}%
                </div>
                <div style="color: #6b7280; font-size: 14px;">Probability</div>
              </div>
              <div class="probability-gauge">
                <div class="probability-fill" style="width: ${probPercent}%; background: ${data.risk_color || '#6b7280'};">
                  ${probPercent >= 10 ? probPercent + '%' : ''}
                </div>
              </div>
              <p style="margin-top: 20px; line-height: 1.6; color: #374151;">
                ${data.advice}
              </p>
              
              <!-- Link to Main Website Protection Plan -->
              <a href="${planUrl}" target="_blank"
                 style="display: inline-block; margin-top: 15px; padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 25px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); transition: transform 0.2s;">
                 üõ°Ô∏è View Custom Plan
              </a>

  <p style="margin-top: 10px; font-size: 12px; color: #6b7280;">
    Label: ${data.label || 'N/A'} | Confidence: ${data.confidence || 'N/A'}
  </p>
  <button class="explain-btn" onclick="explainPrediction()">Why this prediction?</button>
  </div>
  `;

          bot(resultHTML, true);
        } else {
          bot("Error: " + (data.detail || JSON.stringify(data)));
        }
      } catch (err) {
        qArea.innerHTML = '';
        bot("Network or server error: " + err.message);
      }
    }

    async function explainPrediction() {
      try {
        const payload = {
          Age: state.Age,
          Num_of_sexual_partners: state.Num_of_sexual_partners,
          First_sex_age: state.First_sex_age,
          Num_of_pregnancies: state.Num_of_pregnancies,
          Smokes_years: state.Smokes_years,
          Hormonal_contraceptives: state.Hormonal_contraceptives,
          Hormonal_contraceptives_years: state.Hormonal_contraceptives_years,
          STDs_HIV: state.STDs_HIV,
          Pain_during_intercourse: state.Pain_during_intercourse,
          Vaginal_discharge_type: state.Vaginal_discharge_type,
          Vaginal_discharge_color: state.Vaginal_discharge_color,
          Vaginal_bleeding_timing: state.Vaginal_bleeding_timing
        };

        const resp = await fetch('/explain', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await resp.json();
        if (resp.ok) {
          let explainHTML = '<h4>Feature Importance:</h4>
            < ul style = "text-align: left; margin-top: 10px;" > ';
          const features = Object.entries(data.feature_importance || {})
            .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]))
            .slice(0, 5);

          features.forEach(([feature, importance]) => {
            const sign = importance > 0 ? '+' : '';
            explainHTML += `<li style="margin: 8px 0;">${feature}: ${sign}${importance.toFixed(4)}</li>`;
          });
          explainHTML += '</ul>';
          bot(explainHTML, true);
        } else {
          bot("Explanation unavailable: " + (data.detail || "SHAP not configured"));
        }
      } catch (err) {
        bot("Error getting explanation: " + err.message);
      }
    }

    // Start conversation
    bot("Hello! I'm here to help assess your cervical health risk. Let's start with a few questions.");
    askNext();
  </script>
</body>

</html>